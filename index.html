<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Özür Dilerim</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(145deg, #ffe0e2 0%, #ffd0d8 40%, #f8b0bb 100%);
            --glass: rgba(255, 255, 255, 0.82);
            --glass-strong: rgba(255, 255, 255, 0.94);
            --primary: #e63946;
            --accent: #ff6f91;
            --shadow: 0 28px 50px rgba(230, 57, 70, 0.16);
            --border: rgba(255, 255, 255, 0.55);
            --hint: rgba(73, 36, 62, 0.62);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: #49243e;
            background: var(--bg-gradient);
            overflow-x: hidden;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: clamp(32px, 6vw, 64px) clamp(18px, 5vw, 48px);
            position: relative;
        }

        .layout {
            position: relative;
            width: min(680px, 100%);
            display: grid;
            gap: clamp(28px, 6vw, 42px);
            z-index: 5;
        }

        .hero {
            text-align: center;
            padding: clamp(18px, 3vw, 26px);
            background: var(--glass);
            border-radius: 26px;
            backdrop-filter: blur(18px);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .hero h1 {
            margin: 0;
            font-size: clamp(2.4rem, 6vw, 3.1rem);
            font-weight: 800;
            letter-spacing: -0.015em;
            color: var(--primary);
            text-shadow: 0 8px 26px rgba(230, 57, 70, 0.28);
        }

        .hero p {
            margin: 12px auto 0;
            max-width: 420px;
            font-size: clamp(1rem, 2.4vw, 1.1rem);
            color: rgba(73, 36, 62, 0.68);
            letter-spacing: 0.03em;
        }

        .card {
            position: relative;
            padding: clamp(30px, 5vw, 44px);
            border-radius: 28px;
            background: var(--glass);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
        }

        .message-card::before,
        .message-card::after {
            content: "";
            position: absolute;
            border-radius: 50%;
            filter: blur(26px);
            opacity: 0.32;
        }

        .message-card::before {
            width: 220px;
            height: 220px;
            top: -90px;
            right: -70px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent 70%);
        }

        .message-card::after {
            width: 240px;
            height: 240px;
            bottom: -100px;
            left: -80px;
            background: radial-gradient(circle, rgba(255, 128, 149, 0.45), transparent 65%);
        }

        .message-shell {
            position: relative;
            max-height: clamp(220px, 42vh, 320px);
            overflow-y: auto;
            margin: 0;
            padding: clamp(22px, 4vw, 30px);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.88);
            box-shadow: inset 0 0 0 1px rgba(230, 57, 70, 0.12);
        }

        .message-shell::-webkit-scrollbar {
            width: 10px;
        }

        .message-shell::-webkit-scrollbar-track {
            background: rgba(255, 202, 211, 0.45);
            border-radius: 999px;
        }

        .message-shell::-webkit-scrollbar-thumb {
            background: rgba(230, 57, 70, 0.56);
            border-radius: 999px;
        }

        .message-shell::-webkit-scrollbar-thumb:hover {
            background: rgba(230, 57, 70, 0.74);
        }

        .message {
            margin: 0;
            font-size: clamp(1.22rem, 3.6vw, 1.52rem);
            line-height: 1.85;
            text-align: center;
        }

        .message::before,
        .message::after {
            content: "\201C";
            display: block;
            font-family: "Georgia", serif;
            font-size: 4.4rem;
            color: rgba(230, 57, 70, 0.18);
        }

        .message::after {
            content: "\201D";
        }

        .scroll-hint {
            margin: 18px auto 0;
            padding: 8px 18px;
            border-radius: 999px;
            background: rgba(255, 235, 238, 0.9);
            color: var(--hint);
            font-size: 0.84rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 220ms ease, transform 220ms ease;
        }

        .scroll-hint::before {
            content: "⇣";
            color: var(--primary);
        }

        .scroll-hint.show {
            opacity: 1;
            transform: translateY(0);
        }

        .footer-line {
            margin-top: 34px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.84rem;
            color: rgba(73, 36, 62, 0.6);
        }

        .heart-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border-radius: 999px;
            background: rgba(255, 167, 183, 0.32);
            color: var(--primary);
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 14px;
            margin-top: clamp(20px, 4vw, 30px);
        }

        .read-button,
        .pill-button {
            border: none;
            border-radius: 999px;
            padding: 14px 30px;
            font-size: 0.98rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 220ms ease, box-shadow 220ms ease, opacity 220ms ease;
        }

        .read-button {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.95), rgba(255, 130, 150, 0.95));
            color: #fff;
            box-shadow: 0 18px 36px rgba(230, 57, 70, 0.26);
        }

        .read-button::before {
            content: "✔";
            font-size: 1rem;
        }

        .read-button.completed {
            background: linear-gradient(135deg, rgba(47, 159, 120, 0.95), rgba(115, 201, 176, 0.95));
            box-shadow: 0 18px 36px rgba(47, 159, 120, 0.26);
        }

        .read-button.completed::before {
            content: "❤";
        }

        .pill-button {
            background: var(--glass-strong);
            color: var(--primary);
            box-shadow: 0 14px 26px rgba(230, 57, 70, 0.16);
        }

        .read-button:hover:not(.disabled):not(:disabled),
        .pill-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .read-button:active:not(.disabled):not(:disabled),
        .pill-button:active:not(:disabled) {
            transform: translateY(1px);
        }

        .read-button.disabled,
        .read-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
        }

        button:focus-visible {
            outline: 3px solid rgba(230, 57, 70, 0.3);
            outline-offset: 2px;
        }

        .game-card {
            display: none;
            gap: clamp(18px, 4vw, 28px);
            opacity: 0;
            transform: translateY(24px);
            transition: opacity 320ms ease, transform 320ms ease;
        }

        .game-card.active {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }

        .celebration-card {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            padding: clamp(24px, 6vw, 40px);
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.92), rgba(255, 143, 163, 0.6));
            backdrop-filter: blur(24px);
            z-index: 30;
            opacity: 0;
            visibility: hidden;
            transition: opacity 320ms ease, visibility 320ms ease;
        }

        .celebration-card.active {
            opacity: 1;
            visibility: visible;
        }

        .celebration-content {
            max-width: 580px;
            width: 100%;
            padding: clamp(38px, 6vw, 56px);
            border-radius: 32px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 30px 70px rgba(230, 57, 70, 0.28);
            position: relative;
            text-align: center;
            overflow: hidden;
            transform: scale(1);
            transition: transform 420ms ease;
        }

        .celebration-content::before,
        .celebration-content::after {
            content: "";
            position: absolute;
            inset: -120px -160px auto;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 168, 186, 0.45), transparent 70%);
            animation: glowSpin 9s linear infinite;
            opacity: 0.6;
        }

        .celebration-content::after {
            inset: auto -160px -120px;
            animation-direction: reverse;
        }

        @keyframes glowSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            100% {
                transform: rotate(360deg) scale(1.2);
            }
        }

        .celebration-title {
            margin: 0;
            font-size: clamp(2.6rem, 6vw, 3.4rem);
            color: var(--primary);
            letter-spacing: -0.02em;
            text-shadow: 0 16px 45px rgba(230, 57, 70, 0.35);
            position: relative;
        }

        .celebration-title::after {
            content: "";
            display: block;
            margin: clamp(18px, 4vw, 28px) auto;
            width: 120px;
            height: 2px;
            background: linear-gradient(90deg, rgba(255, 153, 172, 0), rgba(255, 51, 92, 0.8), rgba(255, 153, 172, 0));
        }

        .celebration-text {
            margin: 0;
            font-size: clamp(1.05rem, 3vw, 1.22rem);
            color: rgba(73, 36, 62, 0.75);
            line-height: 1.8;
            position: relative;
            transition: opacity 320ms ease;
        }

        .celebration-text.hidden {
            opacity: 0;
        }

        .firework-field {
            position: absolute;
            inset: -10%;
            pointer-events: none;
        }

        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff003f;
            opacity: 0;
            animation: explode 1s ease-out forwards;
        }

        .celebration-heart {
            display: none;
            position: relative;
            width: 120px;
            height: 120px;
            margin: clamp(20px, 4vw, 32px) auto 0;
            transform: scale(0.2);
            filter: drop-shadow(0 18px 28px rgba(230, 57, 70, 0.35));
        }

        .celebration-heart::before,
        .celebration-heart::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: #ff003f;
        }

        .celebration-heart::before {
            top: -50%;
        }

        .celebration-heart::after {
            left: -50%;
        }

        .celebration-heart.active {
            display: block;
            animation: heartGrow 15s ease-in-out forwards;
        }

        .celebration-heart.explode {
            animation: heartExplode 1s ease-out forwards;
        }

        @keyframes heartGrow {
            0% {
                transform: scale(0.2);
                opacity: 0.6;
            }
            30% {
                opacity: 1;
            }
            100% {
                transform: scale(4.5);
                opacity: 1;
            }
        }

        @keyframes heartExplode {
            0% {
                transform: scale(4.5);
                opacity: 1;
            }
            100% {
                transform: scale(6.2);
                opacity: 0;
            }
        }

        .celebration-card.exiting {
            opacity: 0;
            visibility: hidden;
            transition-delay: 1.2s;
        }

        .celebration-card.exiting .celebration-content {
            transform: scale(3.6);
            opacity: 0;
            transition-duration: 1.1s;
        }

        @keyframes explode {
            0% {
                opacity: 1;
                transform: scale(0.2);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(2.8);
            }
        }

        .game-card .action-buttons {
            margin-top: 0;
        }

        .game-stats {
            display: flex;
            gap: 18px;
            justify-content: center;
            font-weight: 600;
            letter-spacing: 0.06em;
            color: rgba(73, 36, 62, 0.72);
        }

        .game-stats strong {
            color: var(--primary);
            font-size: 1.02rem;
        }

        .game-card p {
            margin: 0;
            text-align: center;
            color: rgba(73, 36, 62, 0.68);
            letter-spacing: 0.02em;
        }

        .game-stage {
            background: linear-gradient(140deg, rgba(255, 237, 241, 0.95), rgba(255, 247, 249, 0.95));
            border-radius: 24px;
            border: 1px solid var(--border);
            padding: clamp(20px, 4vw, 28px);
            box-shadow: inset 0 0 0 1px rgba(230, 57, 70, 0.1);
        }

        .lantern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: clamp(14px, 3vw, 24px);
        }

        .lantern {
            position: relative;
            border-radius: 19px;
            height: clamp(110px, 16vh, 138px);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(255, 202, 210, 0.72));
            border: 1px solid rgba(255, 255, 255, 0.85);
            box-shadow: 0 14px 26px rgba(230, 57, 70, 0.16);
            cursor: pointer;
            overflow: hidden;
            transition: transform 220ms ease, box-shadow 220ms ease;
        }

        .lantern:hover {
            transform: translateY(-4px);
        }

        .lantern.is-found {
            cursor: default;
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 18px 32px rgba(230, 57, 70, 0.2);
        }

        .lantern::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 19px;
            border: 1px dashed rgba(230, 57, 70, 0.22);
        }

        .lantern-body {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 1.08rem;
            letter-spacing: 0.06em;
            color: rgba(73, 36, 62, 0.72);
            z-index: 2;
            transition: color 220ms ease;
        }

        .lantern-light {
            position: absolute;
            inset: 12px;
            border-radius: 16px;
            background: radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.85), transparent 70%);
            opacity: 0;
            transition: opacity 320ms ease;
        }

        .lantern.is-found .lantern-light {
            opacity: 1;
        }

        .lantern-message {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            padding: 0 18px;
            text-align: center;
            font-size: 0.94rem;
            color: rgba(73, 36, 62, 0.82);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 240ms ease, transform 240ms ease;
        }

        .lantern.is-found .lantern-message {
            opacity: 1;
            transform: translateY(0);
        }

        .lantern-floating {
            position: absolute;
            top: -12px;
            left: 50%;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            transform: translateX(-50%);
            filter: blur(1px);
            animation: floatLantern 2.8s ease-in-out infinite;
        }

        .lantern.is-found .lantern-floating {
            background: rgba(255, 255, 255, 0.92);
        }

        @keyframes floatLantern {
            0%, 100% {
                transform: translate(-50%, 0);
            }
            50% {
                transform: translate(-50%, -10px);
            }
        }

        .emoji-flare {
            position: absolute;
            left: 50%;
            bottom: 36%;
            transform: translate(-50%, 0) scale(0.75);
            font-size: 1.6rem;
            pointer-events: none;
            opacity: 0;
            color: #ff003f;
            animation: flareUp 0.8s ease-out forwards;
        }

        @keyframes flareUp {
            0% {
                opacity: 0;
                transform: translate(-50%, 12px) scale(0.75);
            }
            15% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -60px) scale(1.35);
            }
        }

        .game-message {
            text-align: center;
            color: rgba(73, 36, 62, 0.78);
            font-weight: 600;
            min-height: 1.4em;
        }

        .game-message strong {
            color: var(--primary);
        }

        .heart-field {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 20;
        }

        .heart-field .heart {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--accent);
            transform: rotate(45deg);
            animation: floatUp 6s linear forwards;
        }

        .heart::before,
        .heart::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: inherit;
        }

        .heart::before {
            top: -50%;
        }

        .heart::after {
            left: -50%;
        }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translateY(16px) scale(0.6) rotate(45deg);
            }
            30% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-320px) scale(1.4) rotate(45deg);
            }
        }

        @media (max-width: 640px) {
            .hero, .card {
                padding: clamp(22px, 5vw, 32px);
            }

            .footer-line {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="heart-field" aria-hidden="true"></div>

    <main class="layout">
        <header class="hero">
            <h1>Özür Dilerim</h1>
            <p>Kalbini yeniden gülümsetmek için burada, tüm samimiyetimle bekliyorum.</p>
        </header>

        <section class="card message-card" id="message-card">
            <div class="message-shell" id="message-shell">
                <p class="message" id="message-text">
                    İçten gelen duygularını buraya yaz. Bu sayfayı her açtığında, kalbinde sakladığın sözler yeniden ışıldasın.
                </p>
            </div>

            <span class="scroll-hint" id="scroll-hint">Aşağı kaydır</span>

            <div class="action-buttons">
                <button class="read-button disabled" id="read-button" type="button" disabled>Mesajı Okudum</button>
                <button class="pill-button" id="starlight-touch" type="button">Kalbime Dokun</button>
            </div>

            <div class="footer-line">
                <span>Kalbim Hep Burada</span>
                <span class="heart-badge">❤ Sonsuza Dek</span>
            </div>
        </section>

        <section class="card game-card" id="game-card" hidden>
            <div class="game-stats">
                <span>Bulunan Fener: <strong id="game-score">0 / 3</strong></span>
            </div>
            <p>Gizli sevgi fenerlerini bul. Her ışıkta sana fısıldadığım başka bir cümle saklı.</p>

            <div class="action-buttons">
                <button class="pill-button" id="game-start" type="button">Fenerleri Uçur</button>
                <button class="pill-button" id="game-restart" type="button" hidden>Bir Tur Daha</button>
                <button class="pill-button" id="game-close" type="button">Oyunu Kapat</button>
            </div>

            <div class="game-stage" id="game-stage" aria-live="polite">
                <div class="lantern-grid" id="lantern-grid"></div>
            </div>

            <div class="game-message" id="game-message"></div>
        </section>
        <section class="celebration-card" id="celebration">
            <div class="celebration-content">
                <div class="firework-field" id="firework-field" aria-hidden="true"></div>
                <h2 class="celebration-title">Tebrikler!</h2>
                <p class="celebration-text">Kalbimi kazandın. Sevgimizin ışığıyla parlamaya devam edelim.</p>
                <div class="celebration-heart" id="celebration-heart" aria-hidden="true"></div>
            </div>
        </section>
    </main>

    <script>
        const layout = document.querySelector(".layout");
        const messageCard = document.getElementById("message-card");
        const messageShell = document.getElementById("message-shell");
        const scrollHint = document.getElementById("scroll-hint");
        const readButton = document.getElementById("read-button");
        const starlightTouch = document.getElementById("starlight-touch");
        const gameCard = document.getElementById("game-card");
        const gameStartButton = document.getElementById("game-start");
        const gameRestartButton = document.getElementById("game-restart");
        const gameCloseButton = document.getElementById("game-close");
        const gameStage = document.getElementById("game-stage");
        const lanternGrid = document.getElementById("lantern-grid");
        const gameScoreEl = document.getElementById("game-score");
        const gameMessage = document.getElementById("game-message");
        const heartField = document.querySelector(".heart-field");
        const celebration = document.getElementById("celebration");
        const fireworkField = document.getElementById("firework-field");
        const celebrationText = celebration?.querySelector(".celebration-text");
        const celebrationHeart = document.getElementById("celebration-heart");
        let celebrationTimers = [];

        const totalHiddenLanterns = 3;
        let gameScoreValue = 0;
        let questTimeoutId = null;
        let gameIsActive = false;

        const STAGE_ACK = "ack";
        const STAGE_READY = "ready";
        const STAGE_PLAYING = "playing";

        if (readButton) {
            readButton.dataset.stage = STAGE_ACK;
        }

        function enableReadButton() {
            if (!readButton) return;
            readButton.classList.remove("disabled");
            readButton.removeAttribute("disabled");
        }

        function disableReadButton() {
            if (!readButton) return;
            readButton.classList.add("disabled");
            readButton.setAttribute("disabled", "disabled");
        }

        function updateScrollHint() {
            if (!messageShell || !scrollHint || !readButton) {
                enableReadButton();
                return;
            }

            const stage = readButton.dataset.stage || STAGE_ACK;
            if (stage !== STAGE_ACK) {
                scrollHint.classList.remove("show");
                enableReadButton();
                return;
            }

            const isOverflowing = messageShell.scrollHeight > messageShell.clientHeight + 4;
            const nearBottom = messageShell.scrollTop + messageShell.clientHeight >= messageShell.scrollHeight - 6;

            if (isOverflowing && !nearBottom) {
                scrollHint.classList.add("show");
                disableReadButton();
            } else {
                scrollHint.classList.remove("show");
                enableReadButton();
            }
        }

        if (messageShell) {
            messageShell.addEventListener("scroll", updateScrollHint);
        }

        function spawnHeart() {
            if (!heartField || !layout) return;

            const heart = document.createElement("span");
            heart.className = "heart";

            const layoutRect = layout.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let x = Math.random() * viewportWidth;
            const padding = 60;
            let guard = 0;

            while (x > layoutRect.left - padding && x < layoutRect.right + padding && guard < 10) {
                x = Math.random() * viewportWidth;
                guard += 1;
            }

            if (x > layoutRect.left - padding && x < layoutRect.right + padding) {
                const spaceLeft = layoutRect.left;
                const spaceRight = viewportWidth - layoutRect.right;
                x = spaceLeft > spaceRight ? layoutRect.left - padding : layoutRect.right + padding;
            }

            heart.style.left = `${Math.max(12, Math.min(viewportWidth - 12, x))}px`;
            heart.style.top = `${viewportHeight - 24}px`;
            heart.style.animationDuration = (4 + Math.random() * 3).toFixed(2) + "s";
            heart.style.background = "#ff003f";

            heartField.appendChild(heart);
            setTimeout(() => heart.remove(), 6000);
        }

        function heartBurst(x, y) {
            if (!heartField) return;
            const rect = heartField.getBoundingClientRect();
            for (let i = 0; i < 8; i += 1) {
                const heart = document.createElement("span");
                heart.className = "heart";
                const offsetX = (Math.random() - 0.5) * 120;
                const offsetY = (Math.random() - 0.5) * 120;
                heart.style.left = `${x - rect.left + offsetX}px`;
                heart.style.top = `${y - rect.top + offsetY}px`;
                heart.style.animationDuration = (3.5 + Math.random() * 1.6).toFixed(2) + "s";
                heart.style.background = "#ff003f";
                heartField.appendChild(heart);
                setTimeout(() => heart.remove(), 5000);
            }
        }

        function launchFireworkBurst() {
            if (!fireworkField) return;
            const colors = ["#ff003f", "#ff6f91", "#ffd166", "#06d6a0", "#118ab2"];
            for (let i = 0; i < 14; i += 1) {
                const spark = document.createElement("span");
                spark.className = "firework";
                spark.style.left = `${Math.random() * 100}%`;
                spark.style.top = `${Math.random() * 100}%`;
                spark.style.background = colors[i % colors.length];
                spark.style.animationDelay = `${(Math.random() * 0.6).toFixed(2)}s`;
                fireworkField.appendChild(spark);
                setTimeout(() => spark.remove(), 1000);
            }
        }

        function clearCelebrationTimers() {
            celebrationTimers.forEach((id) => clearTimeout(id));
            celebrationTimers = [];
        }

        function showCelebration(finalQuote) {
            if (!celebration) return;
            if (celebrationText && finalQuote) {
                celebrationText.innerHTML = `Kalbimi kazandın. <strong>${finalQuote}</strong>`;
            } else if (celebrationText) {
                celebrationText.innerHTML = "Kalbimi kazandın. Sevgimizin ışığıyla parlamaya devam edelim.";
            }

            clearCelebrationTimers();

            if (celebrationText) {
                celebrationText.style.display = "";
                celebrationText.classList.remove("hidden");
            }
            if (celebrationHeart) {
                celebrationHeart.classList.remove("active", "explode");
                celebrationHeart.style.display = "none";
            }

            celebration.classList.remove("exiting");
            celebration.classList.add("active");
            launchFireworkBurst();
            const loop = setInterval(launchFireworkBurst, 1100);
            celebration.dataset.fireworkLoop = String(loop);

            const heartTimer = setTimeout(() => {
                if (celebrationText) {
                    celebrationText.classList.add("hidden");
                    const hideTextTimer = setTimeout(() => {
                        if (celebrationText) celebrationText.style.display = "none";
                    }, 400);
                    celebrationTimers.push(hideTextTimer);
                }
                if (celebrationHeart) {
                    celebrationHeart.style.display = "block";
                    celebrationHeart.classList.remove("explode");
                    celebrationHeart.classList.add("active");
                }

                const explodeTimer = setTimeout(() => {
                    if (celebrationHeart) {
                        celebrationHeart.classList.add("explode");
                    }
                    const finishTimer = setTimeout(() => {
                        hideCelebration();
                        resetToStart();
                    }, 1000);
                    celebrationTimers.push(finishTimer);
                }, 15000);
                celebrationTimers.push(explodeTimer);
            }, 10000);
            celebrationTimers.push(heartTimer);
        }

        function hideCelebration() {
            if (!celebration) return;
            const loopId = celebration.dataset.fireworkLoop;
            if (loopId) {
                clearInterval(Number(loopId));
                delete celebration.dataset.fireworkLoop;
            }
            const exitTimer = celebration.dataset.exitTimer;
            if (exitTimer) {
                clearTimeout(Number(exitTimer));
                delete celebration.dataset.exitTimer;
            }
            clearCelebrationTimers();
            if (celebrationHeart) {
                celebrationHeart.classList.remove("active", "explode");
                celebrationHeart.style.display = "none";
            }
            if (celebrationText) {
                celebrationText.classList.remove("hidden");
                celebrationText.style.display = "";
            }
            celebration.classList.remove("active", "exiting");
        }

        function resetToStart() {
            resetGameState();
            if (gameCard) {
                gameCard.classList.remove("active");
                gameCard.hidden = true;
            }
            if (messageCard) messageCard.hidden = false;
            if (readButton) {
                readButton.dataset.stage = STAGE_READY;
                readButton.classList.add("completed");
                readButton.textContent = "Oyuna Hazırım";
                enableReadButton();
            }
            if (celebrationHeart) {
                celebrationHeart.classList.remove("active", "explode");
                celebrationHeart.style.display = "none";
            }
            if (celebrationText) {
                celebrationText.classList.remove("hidden");
                celebrationText.style.display = "";
            }
            updateScrollHint();
        }

        function resetGameState() {
            if (questTimeoutId) {
                clearTimeout(questTimeoutId);
                questTimeoutId = null;
            }
            gameScoreValue = 0;
            gameIsActive = false;
            if (gameScoreEl) gameScoreEl.textContent = `${gameScoreValue} / ${totalHiddenLanterns}`;
            if (gameMessage) gameMessage.textContent = "";
            if (lanternGrid) lanternGrid.innerHTML = "";
        }

        const gentleMessages = [
            "Seni düşününce kalbim ışıkla doluyor.",
            "Gülüşün içimde çiçekler açtırıyor.",
            "Yanında her şey daha yumuşak.",
            "Birlikte olduğumuzda dünya duruyor.",
            "Sesin uzaktayken bile beni sarıyor.",
            "Kalbimin ritmini seninle buldum.",
            "Her gün seni yeniden seviyorum.",
            "Gözlerin benim en güvenli limanım.",
            "Seninle umutlanıyorum.",
            "İyi ki kalbime dokundun."
        ];

        const goldenMessages = [
            "Seni mutlu etmek en büyük dileğim.",
            "Kalbimle attığım her adım senin için.",
            "Sevgimiz her gün yeniden filizleniyor.",
            "Seni sevmek nefes almak gibi."
        ];

        function shuffle(list) {
            const arr = list.slice();
            for (let i = arr.length - 1; i > 0; i -= 1) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function launchEmojiFlare(lantern, symbol) {
            if (!lantern) return;
            const flare = document.createElement("span");
            flare.className = "emoji-flare";
            flare.textContent = symbol;
            lantern.appendChild(flare);
            flare.addEventListener("animationend", () => flare.remove());
        }

        function revealLantern(lantern, isGolden) {
            if (!lantern || lantern.classList.contains("is-found")) return;
            lantern.classList.add("is-found");

            const body = lantern.querySelector(".lantern-body");
            const messageElement = lantern.querySelector(".lantern-message");
            const quote = lantern.dataset.message || "";

            if (body) {
                body.textContent = "";
            }

            launchEmojiFlare(lantern, isGolden ? "❤" : "✨");

            if (messageElement) {
                messageElement.textContent = quote;
            }

            if (gameMessage) {
                if (isGolden) {
                    const order = gameScoreValue + 1;
                    gameMessage.innerHTML = `Altın fener ${order}. sırrı: <strong>${quote}</strong>`;
                } else {
                    gameMessage.innerHTML = `Fener fısıldadı: <strong>${quote}</strong>`;
                }
            }

            if (isGolden) {
                gameScoreValue += 1;
                if (gameScoreEl) gameScoreEl.textContent = `${gameScoreValue} / ${totalHiddenLanterns}`;
                if (gameScoreValue >= totalHiddenLanterns) {
                    questTimeoutId = setTimeout(() => completeLanternQuest(quote), 520);
                }
            }
        }

        function renderLanterns() {
            if (!lanternGrid) return;

            const totalLanterns = 12;
            const indices = Array.from({ length: totalLanterns }, (_, index) => index);
            const goldenSet = new Set(shuffle(indices).slice(0, totalHiddenLanterns));

            const gentlePool = shuffle(gentleMessages);
            const goldenPool = shuffle(goldenMessages);
            let gentleIndex = 0;
            let goldenIndex = 0;

            lanternGrid.innerHTML = "";

            for (let i = 0; i < totalLanterns; i += 1) {
                const isGolden = goldenSet.has(i);
                const message = isGolden
                    ? goldenPool[goldenIndex++ % goldenPool.length]
                    : gentlePool[gentleIndex++ % gentlePool.length];

                const lantern = document.createElement("button");
                lantern.type = "button";
                lantern.className = "lantern";
                lantern.dataset.message = message;
                lantern.dataset.golden = isGolden ? "true" : "false";

                lantern.innerHTML = `
                    <span class="lantern-floating"></span>
                    <span class="lantern-light"></span>
                    <span class="lantern-body">Tıkla</span>
                    <span class="lantern-message"></span>
                `;

                lantern.addEventListener("click", () => revealLantern(lantern, isGolden));
                lanternGrid.appendChild(lantern);
            }
        }

        function completeLanternQuest(finalQuote) {
            if (questTimeoutId) {
                clearTimeout(questTimeoutId);
                questTimeoutId = null;
            }
            gameIsActive = false;

            if (gameMessage) {
                const closing = finalQuote ? `<strong>${finalQuote}</strong>` : "";
                gameMessage.innerHTML = `Tüm gizli fenerleri buldun! ${closing}<br>Kalbim artık daha da parlak.`;
            }

            if (gameStartButton) {
                gameStartButton.disabled = false;
                gameStartButton.textContent = "Fenerleri Yeniden Diz";
            }

            if (gameRestartButton) {
                gameRestartButton.hidden = false;
                gameRestartButton.disabled = false;
                gameRestartButton.textContent = "Bir Tur Daha";
            }

            showCelebration(finalQuote);
        }

        function openGameArea() {
            resetGameState();
            if (messageCard) messageCard.hidden = true;

            if (gameCard) {
                gameCard.hidden = false;
                requestAnimationFrame(() => gameCard.classList.add("active"));
            }

            if (gameRestartButton) gameRestartButton.hidden = true;
            if (readButton) {
                readButton.dataset.stage = STAGE_PLAYING;
                enableReadButton();
            }
        }

        function startLanternGame() {
            if (!readButton || readButton.dataset.stage !== STAGE_PLAYING) {
                return;
            }
            if (!gameCard || gameCard.hidden || !gameCard.classList.contains("active")) {
                return;
            }

            gameIsActive = true;
            resetGameState();

            if (gameStartButton) {
                gameStartButton.disabled = true;
                gameStartButton.textContent = "Fenerler Uçuyor...";
            }

            if (gameRestartButton) {
                gameRestartButton.hidden = false;
                gameRestartButton.disabled = true;
                gameRestartButton.textContent = "Karıştırılıyor...";
            }

            if (gameMessage) {
                gameMessage.textContent = "Işığı takip et, sevgili notları bul.";
            }

            renderLanterns();

            setTimeout(() => {
                if (gameStartButton) {
                    gameStartButton.disabled = false;
                    gameStartButton.textContent = "Fenerleri Yeniden Diz";
                }
                if (gameRestartButton) {
                    gameRestartButton.disabled = false;
                    gameRestartButton.textContent = "Fenerleri Karıştır";
                }
            }, 420);
        }

        if (gameStartButton) gameStartButton.addEventListener("click", startLanternGame);
        if (gameRestartButton) gameRestartButton.addEventListener("click", startLanternGame);

        if (readButton) {
            readButton.addEventListener("click", () => {
                if (readButton.classList.contains("disabled")) return;

                const stage = readButton.dataset.stage || STAGE_ACK;

                if (stage === STAGE_ACK) {
                    readButton.dataset.stage = STAGE_READY;
                    readButton.classList.add("completed");
                    readButton.textContent = "Oyuna Hazırım";
                    enableReadButton();
                    scrollHint?.classList.remove("show");
                    return;
                }

                if (stage === STAGE_READY) {
                    openGameArea();
                }
            });
        }

        if (gameCloseButton) {
            gameCloseButton.addEventListener("click", () => {
                hideCelebration();
                resetToStart();
            });
        }


        if (starlightTouch) {
            starlightTouch.addEventListener("click", (event) => {
                heartBurst(event.clientX, event.clientY);
            });
        }

        window.addEventListener("load", () => {
            updateScrollHint();
            for (let i = 0; i < 3; i += 1) {
                setTimeout(spawnHeart, i * 220);
            }
            setInterval(() => {
                for (let i = 0; i < 2; i += 1) {
                    setTimeout(spawnHeart, i * 280);
                }
            }, 1800);
        });

        window.addEventListener("resize", updateScrollHint);

        updateScrollHint();
    </script>
</body>
</html>

